Sample 2: 

Hash SHA256: 1acfea4218390a872b340873b71343f6d360b5b9a9e300534e59a69fb4d9b924


#Dumping the contents of the .one file using onedump.py

```bash
remnux@remnux:~/Downloads/onenote malware$ python3 `onedump.py` 1acfea4218390a872b340873b71343f6d360b5b9a9e300534e59a69fb4d9b924.zip 
File: 1acfea4218390a872b340873b71343f6d360b5b9a9e300534e59a69fb4d9b924.zip (extracted)
 1: 0x000021c0 .PNG 89504e47 0x0000066b 39030c475ba311552e78174ba337615b
 2: 0x00002980 @ech 40656368 0x0000c3d6 83cf6ce694b7f50b776928ad2a972689
 3: 0x0000f338 .PNG 89504e47 0x0000145d ddb6da5a6385b9a062409e605c66f682
```


#exctracting the Stream 2 from the list
```bash
remnux@remnux:~/Downloads/onenote malware$ python3 onedump.py 1acfea4218390a872b340873b71343f6d360b5b9a9e300534e59a69fb4d9b924.zip -s 2 -d > dump3.txt
```

The content of the dump3.txt can be reviewed [HERE](https://github.com/cosmin-stan/Malware-Analysis/blob/main/Malware/OneNote%20Malware/dump3.md)

Preview:

![image](https://user-images.githubusercontent.com/36852270/218413988-137ea175-b129-4508-8040-b3d08fbbead1.png)

The content of the dump3.txt is encrypted and it is hard to understand something from it.
The main payload is located in this large block of encrypted code:

![](https://github.com/cosmin-stan/Malware-Analysis/blob/main/Media/block%20of%20strings.gif)

We can easily deofuscate it by adding echo commands at the end of the script to grab the decryption keys:

![image](https://user-images.githubusercontent.com/36852270/218984531-7f67f42f-0d41-4930-a652-192c954495dc.png)

So, we added 3 echo commands at the beggining of those 3 last lines.

Next, we will have to rename it into dump3.bat and use powershell to run it and save the output into another txt. (dump3-clear.txt)

![image](https://user-images.githubusercontent.com/36852270/218985504-c416a323-2eef-4622-97f7-41a513180df7.png)

![image](https://user-images.githubusercontent.com/36852270/218989770-1652359b-bc3b-4e19-a8df-1ded36f209d0.png)

We can understand from the code itself that it does decryption and compression for the malicious executable.
From the code, we can grab the AES decryption keys:

![image](https://user-images.githubusercontent.com/36852270/218990387-fe96e0be-378c-463b-b630-52313ad31083.png)


To decrypt it we can use Cyberchef by copying that huge block of strings mentioned above and insert it into Cyberchef with a `From Base64` recipe:


https://user-images.githubusercontent.com/36852270/220191586-2872de54-b5a4-433b-a9dc-17c99042fe2c.mp4



Cyberchef couldn't decode it because it is AES encrypted.
Insert `AES Decryptor` into the recipe list and add the decryption keys like in the above video.
After we decypted it, the file needs to be unzipped, we use `Gunzip`.
Now, the file is unzipped, to grab the hash of the final stage file, insert `SHA2` recipe and modify it to SHA256 and grab the output and check it on Virus total.

![image](https://user-images.githubusercontent.com/36852270/219569321-45cfc14b-8f1f-4def-ba64-763e195da6a1.png)



